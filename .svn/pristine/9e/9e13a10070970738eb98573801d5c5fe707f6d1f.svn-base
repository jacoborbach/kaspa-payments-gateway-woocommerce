<?php
/**
 * Plugin Name: Kaspa Payments Gateway for WooCommerce
 * Plugin URI: https://wordpress.org/plugins/kaspa-payments-gateway-woocommerce/
 * Description: Accept Kaspa (KAS) cryptocurrency payments in WooCommerce with automatic order confirmation and real-time verification. KPUB watch-only wallet for secure, non-custodial payments. This plugin is not officially affiliated with Kaspa or WooCommerce.
 * Version: 1.0.0
 * Requires at least: 5.0
 * Requires PHP: 7.4
 * Tested up to: 6.8
 * Author: Jacob Orbach
 * Author URI: https://github.com/jacoborbach
 * License: GPL v2 or later
 * License URI: https://www.gnu.org/licenses/gpl-2.0.html
 * Text Domain: kaspa-payments-gateway-woocommerce
 * Requires Plugins: woocommerce
 * WC requires at least: 3.0
 * WC tested up to: 8.0
 */

// Prevent direct access
if (!defined('ABSPATH')) {
    exit;
}

/**
 * AJAX handler for saving KPUB wallet - MOVED TO TOP
 */
function kasppaga_save_kpub_wallet()
{
    // Verify nonce
    if (!isset($_POST['nonce']) || !wp_verify_nonce(sanitize_text_field(wp_unslash($_POST['nonce'])), 'kasppaga_save_kpub_wallet')) {
        wp_send_json_error('Invalid nonce');
        return;
    }

    $kpub = isset($_POST['kpub']) ? sanitize_text_field(wp_unslash($_POST['kpub'])) : '';
    $address = isset($_POST['address']) ? sanitize_text_field(wp_unslash($_POST['address'])) : '';

    if (empty($kpub) || empty($address)) {
        error_log('KASPA: Missing data - kpub: ' . (!empty($kpub) ? 'present' : 'missing') . ', address: ' . (!empty($address) ? 'present' : 'missing'));
        wp_send_json_error('Missing KPUB or address data');
        return;
    }

    // Save the KPUB and address
    update_option('kasppaga_wallet_kpub', $kpub);
    update_option('kasppaga_wallet_address', $address);
    update_option('kasppaga_wallet_configured', true);

    error_log('KASPA: Successfully saved KPUB: ' . substr($kpub, 0, 20) . '... and address: ' . $address);

    wp_send_json_success('KPUB wallet saved successfully');
}

// Register AJAX hooks immediately
add_action('wp_ajax_kasppaga_save_kpub_wallet', 'kasppaga_save_kpub_wallet');
add_action('wp_ajax_nopriv_kasppaga_save_kpub_wallet', 'kasppaga_save_kpub_wallet');

/**
 * DEDICATED PAYMENT PAGE FUNCTIONALITY
 */

// Add rewrite rule for payment page
add_action('init', 'kasppaga_add_payment_rewrite_rule');
function kasppaga_add_payment_rewrite_rule()
{
    add_rewrite_rule(
        '^kaspa-payment/([0-9]+)/([a-zA-Z0-9_]+)/?$',
        'index.php?kaspa_payment_page=1&order_id=$matches[1]&order_key=$matches[2]',
        'top'
    );
}

// Add query vars
add_filter('query_vars', 'kasppaga_add_payment_query_vars');
function kasppaga_add_payment_query_vars($vars)
{
    $vars[] = 'kaspa_payment_page';
    $vars[] = 'order_id';
    $vars[] = 'order_key';
    return $vars;
}

// Handle the payment page
add_action('template_redirect', 'kasppaga_handle_dedicated_payment_page');
function kasppaga_handle_dedicated_payment_page()
{
    if (get_query_var('kaspa_payment_page')) {
        $order_id = intval(get_query_var('order_id'));
        $order_key = sanitize_text_field(get_query_var('order_key'));

        error_log('Kaspa: Dedicated payment page accessed - Order: ' . $order_id);

        if (!$order_id || !$order_key) {
            wp_die('Invalid payment link.');
        }

        $order = wc_get_order($order_id);
        if (!$order || $order->get_order_key() !== $order_key) {
            wp_die('Invalid order or order key.');
        }

        // Check if payment is already completed
        if (in_array($order->get_status(), ['processing', 'completed'])) {
            $gateway = new KASPPAGA_WC_Gateway();
            wp_safe_redirect($gateway->get_return_url($order));
            exit;
        }

        // Display the payment page
        kasppaga_display_dedicated_payment_page($order);
        exit;
    }
}

// Display the dedicated payment page
function kasppaga_display_dedicated_payment_page($order)
{
    ?>
    <!DOCTYPE html>
    <html <?php language_attributes(); ?>>

    <head>
        <meta charset="<?php bloginfo('charset'); ?>">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Complete Kaspa Payment - Order #<?php echo esc_html($order->get_id()); ?></title>
        <?php
        // Load WordPress header scripts
        wp_head();

        // Enqueue wallet library
        wp_enqueue_script(
            'kaspa-wallet-bundle',
            plugin_dir_url(__FILE__) . 'assets/kaspa-wallet.js',
            array('jquery'),
            '1.0.0',
            true
        );
        ?>
        <style>
            body {
                margin: 0;
                padding: 0;
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            }

            .kaspa-payment-wrapper {
                min-height: 100vh;
                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                padding: 40px 20px;
            }

            .kaspa-container {
                max-width: 900px;
                margin: 0 auto;
            }

            .kaspa-header {
                text-align: center;
                margin-bottom: 40px;
                background: rgba(255, 255, 255, 0.9);
                padding: 30px;
                border-radius: 20px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            }

            .kaspa-header h1 {
                font-size: 36px;
                margin-bottom: 16px;
                color: #333;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }

            .kaspa-header p {
                font-size: 18px;
                color: #666;
                margin: 0;
            }
        </style>
    </head>

    <body <?php body_class(); ?>>

        <div class="kaspa-payment-wrapper">
            <div class="kaspa-container">

                <!-- Page Header -->
                <div class="kaspa-header">
                    <h1>ðŸ’° Complete Your Payment</h1>
                    <p>
                        Order #<?php echo esc_html($order->get_id()); ?> â€¢
                        <?php echo wp_kses_post(wc_price($order->get_total())); ?>
                    </p>
                </div>

                <!-- Payment Interface -->
                <?php
                $gateway = new KASPPAGA_WC_Gateway();
                kasppaga_display_thankyou_page($order->get_id(), $gateway);
                ?>

            </div>
        </div>

        <?php wp_footer(); ?>
    </body>

    </html>
    <?php
}

/**
 * Main plugin class
 */
class KASPPAGA_Plugin
{
    public function __construct()
    {
        add_action('plugins_loaded', array($this, 'init'), 11);
        add_action('before_woocommerce_init', array($this, 'declare_hpos_compatibility'));

        // Register blocks integration for WooCommerce block checkout support
        add_action('woocommerce_blocks_loaded', array($this, 'register_blocks_integration'));
        // WebSocket AJAX hooks removed - using polling system instead

    }

    /**
     * Initialize the plugin
     */
    public function init()
    {
        if (!class_exists('WooCommerce') || !class_exists('WC_Payment_Gateway')) {
            return;
        }

        $this->load_includes();
        add_filter('woocommerce_payment_gateways', array($this, 'add_gateway'));
    }

    /**
     * Declare HPOS compatibility
     */
    public function declare_hpos_compatibility()
    {
        if (class_exists('\Automattic\WooCommerce\Utilities\FeaturesUtil')) {
            \Automattic\WooCommerce\Utilities\FeaturesUtil::declare_compatibility('custom_order_tables', __FILE__, true);
        }
    }

    /**
     * Load required files
     */
    private function load_includes()
    {
        $gateway_file = plugin_dir_path(__FILE__) . 'includes/class-wc-kaspa-gateway.php';
        $frontend_file = plugin_dir_path(__FILE__) . 'includes/kaspa-frontend-assets.php';
        $polling_file = plugin_dir_path(__FILE__) . 'includes/kaspa-transaction-polling.php';
        $admin_file = plugin_dir_path(__FILE__) . 'includes/class-kaspa-admin-dashboard.php';
        $xpub_setup_file = plugin_dir_path(__FILE__) . 'includes/kaspa-wallet-setup.php';

        // Check if files exist before loading
        if (file_exists($gateway_file)) {
            require_once $gateway_file;
        } else {
            add_action('admin_notices', array($this, 'missing_files_notice'));
            error_log('Kaspa Gateway file not found at: ' . $gateway_file);
            return;
        }

        if (file_exists($frontend_file)) {
            require_once $frontend_file;
        } else {
            add_action('admin_notices', array($this, 'missing_files_notice'));
            error_log('Kaspa Frontend file not found at: ' . $frontend_file);
            return;
        }

        if (file_exists($polling_file)) {
            require_once $polling_file;
        } else {
            add_action('admin_notices', array($this, 'missing_files_notice'));
            error_log('Kaspa Polling file not found at: ' . $polling_file);
            return;
        }

        if (file_exists($admin_file)) {
            require_once $admin_file;
        } else {
            add_action('admin_notices', array($this, 'missing_files_notice'));
            error_log('Kaspa Admin file not found at: ' . $admin_file);
            return;
        }

        if (file_exists($xpub_setup_file)) {
            require_once $xpub_setup_file;
        } else {
            add_action('admin_notices', array($this, 'missing_files_notice'));
            error_log('Kaspa Setup file not found at: ' . $xpub_setup_file);
            return;
        }
    }

    /**
     * Show admin notice for missing files
     */
    public function missing_files_notice()
    {
        $gateway_file = plugin_dir_path(__FILE__) . 'includes/class-wc-kaspa-gateway.php';
        $frontend_file = plugin_dir_path(__FILE__) . 'includes/kaspa-frontend-assets.php';
        ?>
        <div class="notice notice-error">
            <p><strong>Kaspa Payments:</strong> Plugin files issue detected.</p>
            <p>Gateway file exists: <?php echo file_exists($gateway_file) ? 'YES' : 'NO'; ?>
                (<?php echo esc_html($gateway_file); ?>)</p>
            <p>Frontend file exists: <?php echo file_exists($frontend_file) ? 'YES' : 'NO'; ?>
                (<?php echo esc_html($frontend_file); ?>)
            </p>
        </div>
        <?php
    }

    /**
     * Add gateway to WooCommerce
     */
    public function add_gateway($methods)
    {
        if (class_exists('KASPPAGA_WC_Gateway')) {
            $methods[] = 'KASPPAGA_WC_Gateway';
        }
        return $methods;
    }

    /**
     * Register streamlined blocks integration for both classic and block checkout
     */
    public function register_blocks_integration()
    {
        // Only register once
        static $registered = false;
        if ($registered) {
            return;
        }

        // Check if required classes exist
        if (!class_exists('Automattic\WooCommerce\Blocks\Payments\Integrations\AbstractPaymentMethodType')) {
            // Blocks not available, skip silently
            return;
        }

        // Load the blocks integration class
        kasppaga_load_blocks_integration_class();

        // Register with WooCommerce Blocks
        add_action('woocommerce_blocks_payment_method_type_registration', function ($payment_method_registry) {
            if (class_exists('Kaspa_Blocks_Integration')) {
                $integration = new Kaspa_Blocks_Integration();
                $payment_method_registry->register($integration);
            }
        });

        $registered = true;
    }
}

/**
 * Load streamlined blocks integration class
 */
function kasppaga_load_blocks_integration_class()
{
    if (class_exists('Kaspa_Blocks_Integration')) {
        return; // Already loaded
    }

    class Kaspa_Blocks_Integration extends \Automattic\WooCommerce\Blocks\Payments\Integrations\AbstractPaymentMethodType
    {
        protected $name = 'kaspa';
        protected $settings = array();

        public function initialize()
        {
            $this->settings = get_option('woocommerce_kaspa_settings', array());

            // Add settings data for JavaScript
            add_action('wp_enqueue_scripts', array($this, 'add_payment_method_data'), 20);
        }

        /**
         * Add payment method data to JavaScript (for blocks checkout)
         */
        public function add_payment_method_data()
        {
            // Only on checkout pages
            if (!is_checkout() && !has_block('woocommerce/checkout')) {
                return;
            }

            // Add the settings data for blocks
            $data = $this->get_payment_method_data();

            wp_add_inline_script(
                'wc-settings',
                'window.wc = window.wc || {}; window.wc.wcSettings = window.wc.wcSettings || {}; window.wc.wcSettings.allSettings = window.wc.wcSettings.allSettings || {}; window.wc.wcSettings.allSettings.kaspa_data = ' . wp_json_encode($data) . ';',
                'after'
            );
        }

        public function is_active()
        {
            $is_enabled = isset($this->settings['enabled']) && $this->settings['enabled'] === 'yes';
            $wallet_configured = get_option('kasppaga_wallet_configured', false);
            return $is_enabled && $wallet_configured;
        }

        public function get_payment_method_script_handles()
        {
            // Use the assets/js/index.js file
            $script_path = plugin_dir_path(__FILE__) . 'assets/js/index.js';
            $script_url = plugin_dir_url(__FILE__) . 'assets/js/index.js';
            $asset_path = plugin_dir_path(__FILE__) . 'assets/js/index.asset.php';

            // Check if files exist
            if (!file_exists($script_path)) {
                return array();
            }

            $asset_file = file_exists($asset_path)
                ? require($asset_path)
                : array(
                    'dependencies' => array('wc-blocks-registry', 'wp-element', 'wp-i18n', 'wc-settings'),
                    'version' => '1.0.2'
                );

            wp_register_script(
                'kaspa-blocks-integration',
                $script_url,
                $asset_file['dependencies'],
                $asset_file['version'],
                true
            );

            return array('kaspa-blocks-integration');
        }

        public function get_payment_method_data()
        {
            return array(
                'title' => isset($this->settings['title']) ? $this->settings['title'] : 'Kaspa (KAS)',
                'description' => isset($this->settings['description']) ? $this->settings['description'] : 'Pay with Kaspa cryptocurrency. Fast and secure.',
                'supports' => array(
                    'features' => array('products')
                )
            );
        }
    }
}

// Initialize the plugin
new KASPPAGA_Plugin();

// debug if kaspa checkout does not show
// add_action('wp_footer', function () {
//     if (is_checkout()) {
//         echo '<script>';
//         echo 'console.log("Gateway class exists:", ' . (class_exists('WC_Kaspa_Clean_Gateway') ? 'true' : 'false') . ');';
//         echo 'console.log("Files loaded successfully:", ' . (function_exists('kaspa_display_thankyou_page') ? 'true' : 'false') . ');';
//         $kaspa_settings = get_option('woocommerce_kaspa_settings', array());
//         echo 'console.log("Kaspa enabled:", "' . ($kaspa_settings['enabled'] ?? 'not set') . '");';
//         echo 'console.log("Kaspa settings:", ' . json_encode($kaspa_settings) . ');';
//         echo '</script>';
//     }
// });

// WebSocket function removed - using polling system instead